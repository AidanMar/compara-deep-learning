import numpy as np
import pandas as pd

configfile:
    "config.json"


# get the list of species names for the homology databases
species = list(np.loadtxt(config["homology_species_list"], dtype="str"))


rule all:
	input:
		expand( "homology_databases/{SPECIES}.homologies.tsv.gz", SPECIES=species ),
		"downloads/gtfs",
		"downloads/cds",
		"downloads/pep"
		
	


rule get_download_links:
	"""
	This rule runs the download links script. 
	This will get the user all of the possible 
	download links for the gtf, cds files and fasta files
	"""
	input:
		"scripts/ftpg.py"
	output:
		"download_links/gtf_link.txt",
		"download_links/seq_link.txt",
		"download_links/protein_seq.txt"
	script:
		"scripts/ftpg.py"

# read the list of seq links
seq_links = pd.Series(np.loadtxt("download_links/seq_link.txt", dtype="str"))
# Get the expected list of seq output files
seq_files = list("downloads/cds/" + seq_links.str.split("/").str[-1])

rule download_cds:
	input:
		"download_links/seq_link.txt"
	output:
		files = seq_files,
		out_dir = directory("downloads/cds"),
		log_path = "logs/seq_download_log.txt"
	shell:
		"scripts/downloader.sh {input} {output.out_dir} {output.log_path}"

rule download_gtf:
	input:
		"download_links/gtf_link.txt"
	output:
		out_dir = directory("downloads/gtfs"),
		log_path = "logs/gtf_download_log.txt"
	shell:
		"scripts/downloader.sh {input} {output.out_dir} {output.log_path}"

rule download_pep:
	input:
		"download_links/protein_seq.txt"
	output:
		out_dir = directory("downloads/pep"),
		log_path = "logs/pep_download_log.txt"
	shell:
		"scripts/downloader.sh {input} {output.out_dir} {output.log_path}"

# rule download_files:
# 	"""
# 	This rule runs the download links script. 
# 	This will get the user all of the possible 
# 	download links for the gtf, cds files and fasta files
# 	"""
# 	input:
# 		"download_links/gtf_link.txt",
# 		"download_links/seq_link.txt",
# 		"download_links/protein_seq.txt"
# 	output:
# 		"downloads/gtfs",
# 		"downloads/cds",
# 		"downloads/pep",
# 		"logs/gtf_download_log.txt",
# 		"logs/pep_download_log.txt",
# 		"logs/seq_download_log.txt"
# 	shell:
# 		"scripts/download_prelims.sh"



rule get_homology_databases:
	input:
		config["homology_species_list"]
	output:
		"homology_databases/{SPECIES}.homologies.tsv.gz"
	params:
		address=config["homology_database_ftp_address"]
		
	
	shell:
		"""
		# make the homology database directory
		mkdir -p homology_databases
		# This mysterious looking piece of code yanks the ftp path homology database for each species
		ftp_address=$(lynx -dump -listonly {params.address}{wildcards.SPECIES} | grep "protein" | tr -s ' ' | rev | cut -d " " -f 1 | rev)
		# Use that address to download file with appropriate name
		wget $ftp_address -q -O {output}
		
		"""


